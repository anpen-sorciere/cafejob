# サーバー設定の次のステップ

## ✅ 完了した作業

- [x] `.htaccess` ファイルをプロジェクトルートに配置

---

## 📋 次に必要な作業

### ステップ1: サーバー用の `.env` ファイルを作成・設定

#### 1-1. ローカル環境で `.env` をコピー

ローカル環境の `.env` ファイルをベースに、サーバー用の `.env` を作成します。

**方法A: ローカルで作成してからアップロード（推奨）**

1. ローカル環境で `.env.example` を `.env.server` にコピー
2. `.env.server` を編集して、以下の設定を変更：

```env
APP_NAME=CafeJob
APP_ENV=production
APP_KEY=                    ← 後で設定（ステップ2参照）
APP_DEBUG=false             ← 必ず false に設定
APP_URL=https://purplelion51.sakura.ne.jp/cafejob

LOG_CHANNEL=stack
LOG_LEVEL=error             ← 本番環境では error 推奨

DB_CONNECTION=mysql
DB_HOST=localhost           ← さくらサーバーでは通常 localhost
DB_PORT=3306
DB_DATABASE=データベース名   ← さくらサーバーのコントロールパネルで確認
DB_USERNAME=ユーザー名       ← さくらサーバーのコントロールパネルで確認
DB_PASSWORD=パスワード      ← さくらサーバーのコントロールパネルで確認
```

3. `.env.server` を `.env` にリネーム
4. FTPでサーバーの `/cafejob/` ディレクトリにアップロード

**方法B: サーバー上で直接作成**

1. FTPクライアントでサーバーの `/cafejob/` ディレクトリに移動
2. 新しいファイル `.env` を作成
3. 上記の内容をコピー&ペースト
4. データベース情報を実際の値に置き換え

#### 1-2. データベース情報の確認方法（さくらサーバー）

1. さくらサーバーのコントロールパネルにログイン
2. 「データベース」→「MySQLデータベース」を選択
3. 以下の情報を確認：
   - **データベース名**: 例) `username_dbname`
   - **ユーザー名**: 例) `username_dbuser`
   - **パスワード**: 設定したパスワード
   - **ホスト名**: 通常は `localhost`

---

### ステップ2: アプリケーションキーを生成

#### 2-1. ローカル環境でキーを生成

ローカル環境のプロジェクトディレクトリで実行：

```bash
php artisan key:generate
```

#### 2-2. 生成されたキーを確認

ローカルの `.env` ファイルを開き、以下のような行を確認：

```env
APP_KEY=base64:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

#### 2-3. サーバーの `.env` にコピー

サーバーの `.env` ファイルを編集し、`APP_KEY=` の行を、ローカルで生成された値に置き換えます。

**FTPクライアントでの編集方法：**
1. サーバーの `.env` ファイルを右クリック
2. 「編集」または「View/Edit」を選択
3. `APP_KEY=` の行を見つけて、ローカルで生成された値を貼り付け
4. 保存

---

### ステップ3: ディレクトリの権限を設定

FTPクライアントで以下のディレクトリの権限を **775** に設定：

**FileZillaの場合：**
1. ディレクトリを右クリック → 「ファイルの属性」を選択
2. 「数値の値」に `775` を入力
3. 「サブディレクトリに再帰的に適用」にチェック
4. 「OK」をクリック

**設定するディレクトリ：**
- `storage` → **775**
- `storage/app` → **775**
- `storage/app/public` → **775**
- `storage/framework` → **775**
- `storage/framework/cache` → **775**
- `storage/framework/sessions` → **775**
- `storage/framework/views` → **775**
- `storage/logs` → **775**
- `bootstrap/cache` → **775**

---

### ステップ4: データベースマイグレーションを実行

#### SSHアクセスがある場合

サーバーにSSHで接続し、以下のコマンドを実行：

```bash
cd /cafejob
php artisan migrate --force
```

**重要**: 本番環境のデータベースにマイグレーションを実行する前に、必ずバックアップを取得してください。

#### SSHアクセスがない場合

以下のいずれかの方法を取ってください：

**方法1: サーバー管理者に依頼**
- SSHで `php artisan migrate --force` を実行してもらう

**方法2: 一時的にSSHアクセスを有効化**
- さくらサーバーのコントロールパネルでSSHアクセスを有効化
- マイグレーション実行後、必要に応じて無効化

**方法3: phpMyAdminで手動実行（非推奨）**
- ローカル環境のデータベース構造を確認
- phpMyAdminでSQLを手動実行
- **注意**: この方法は複雑でエラーが発生しやすいため、推奨しません

---

### ステップ5: 動作確認

1. **ブラウザでアクセス**
   ```
   https://purplelion51.sakura.ne.jp/cafejob/
   ```

2. **確認事項**
   - [ ] エラーページが表示されない
   - [ ] Laravelのページが表示される
   - [ ] CSSや画像が正しく読み込まれる
   - [ ] ログイン機能が動作する（テスト）

3. **エラーが表示される場合**
   - `storage/logs/laravel.log` を確認
   - エラーメッセージに基づいて対処

---

## 🔍 トラブルシューティング

### 500 Internal Server Error が表示される場合

1. **ログファイルを確認**
   - FTPで `storage/logs/laravel.log` をダウンロード
   - エラーメッセージを確認

2. **よくある原因**
   - `APP_KEY` が設定されていない
   - データベース接続エラー
   - ディレクトリの権限が不足している
   - `.env` ファイルの設定ミス

### データベース接続エラー

1. `.env` ファイルのデータベース設定を確認
2. さくらサーバーのコントロールパネルでデータベース情報を再確認
3. `DB_HOST` が `localhost` になっているか確認

### 画像やCSSが表示されない

1. `public/storage` がシンボリックリンクになっているか確認
2. SSHで `php artisan storage:link` を実行（SSHアクセスがある場合）
3. アセットのパスが正しいか確認

---

## 📝 チェックリスト

デプロイ前に以下を確認：

- [ ] `.htaccess` ファイルがプロジェクトルートに配置されている
- [ ] `.env` ファイルがサーバーにアップロードされている
- [ ] `APP_URL` が `https://purplelion51.sakura.ne.jp/cafejob` に設定されている（末尾スラッシュなし）
- [ ] `APP_DEBUG=false` に設定されている
- [ ] `APP_KEY` が設定されている
- [ ] データベース情報が正しく設定されている
- [ ] `storage` と `bootstrap/cache` の権限が **775** に設定されている
- [ ] データベースマイグレーションが実行されている

---

## 🎯 次のアクション

1. **まず `.env` ファイルを設定**（ステップ1）
2. **アプリケーションキーを生成**（ステップ2）
3. **ディレクトリの権限を設定**（ステップ3）
4. **データベースマイグレーションを実行**（ステップ4）
5. **動作確認**（ステップ5）

不明な点があれば、お気軽にお聞きください！

